apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaConnector
metadata:
  name: oem-kafka-to-iceberg
  namespace: kafka
  labels:
    strimzi.io/cluster: connect-cluster
spec:
  # Using Apache Iceberg Kafka Connect Sink
  # Reference: https://iceberg.apache.org/docs/latest/kafka-connect/
  class: org.apache.iceberg.connect.IcebergSinkConnector
  tasksMax: 1
  config:
    topics: >-
      oem_push_data_bmw,
      oem_push_data_ford,
      oem_push_data_kia,
      oem_push_data_mercedes-benz,
      oem_push_data_renault,
      oem_push_data_stellantis,
      oem_push_data_tesla,
      oem_push_data_volkswagen,
      oem_push_data_volvo-cars

    # Iceberg catalog configuration - Apache Polaris
    iceberg.catalog.type: rest
    iceberg.catalog.uri: http://polaris.polaris.svc.cluster.local:8181/api/catalog
    iceberg.catalog.warehouse: ingestion
    iceberg.catalog.credential: "${secrets:polaris/polaris-user-creds:clientId}:${secrets:polaris/polaris-user-creds:clientSecret}"
    iceberg.catalog.scope: PRINCIPAL_ROLE:ALL

    # S3 file I/O configuration (passed through REST catalog)
    iceberg.catalog.io-impl: org.apache.iceberg.aws.s3.S3FileIO
    iceberg.catalog.s3.endpoint: https://s3.fr-par.scw.cloud
    iceberg.catalog.s3.access-key-id: "${secrets:polaris/polaris-s3-credentials:awsAccessKeyId}"
    iceberg.catalog.s3.secret-access-key: "${secrets:polaris/polaris-s3-credentials:awsSecretAccessKey}"
    iceberg.catalog.client.region: "fr-par"

    # Table configuration (Explicitly listed)
    iceberg.tables: >-
      bmw.raw_data,
      ford.raw_data,
      kia.raw_data,
      mercedes_benz.raw_data,
      renault.raw_data,
      stellantis.raw_data,
      tesla.raw_data,
      volkswagen.raw_data,
      volvo_cars.raw_data

    iceberg.tables.auto-create-enabled: false
    iceberg.tables.evolve-schema-enabled: false

    # Explicit routing
    iceberg.table.bmw.raw_data.route-regex: oem_push_data_bmw
    iceberg.table.ford.raw_data.route-regex: oem_push_data_ford
    iceberg.table.kia.raw_data.route-regex: oem_push_data_kia
    iceberg.table.mercedes_benz.raw_data.route-regex: oem_push_data_mercedes-benz
    iceberg.table.renault.raw_data.route-regex: oem_push_data_renault
    iceberg.table.stellantis.raw_data.route-regex: oem_push_data_stellantis
    iceberg.table.tesla.raw_data.route-regex: oem_push_data_tesla
    iceberg.table.volkswagen.raw_data.route-regex: oem_push_data_volkswagen
    iceberg.table.volvo_cars.raw_data.route-regex: oem_push_data_volvo-cars

    # Control configuration
    iceberg.control.commit.interval-ms: 3600000 # Commit every 60 minutes
    iceberg.control.commit.timeout-ms: 60000

    # Value converter configuration
    key.converter: org.apache.kafka.connect.storage.StringConverter
    value.converter: org.apache.kafka.connect.json.JsonConverter
    value.converter.schemas.enable: "false"
